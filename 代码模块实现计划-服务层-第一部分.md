# Mac屏幕录制与截图软件 - 服务层模块设计 (第一部分)

## 1. 权限管理服务 (PermissionService)

### 1.1 权限类型和状态管理
```swift
// 权限类型枚举
enum PermissionType: String, CaseIterable {
    case screenRecording = "screen_recording"
    case microphone = "microphone"
    case camera = "camera"
    case accessibility = "accessibility"
    case fullDiskAccess = "full_disk_access"
    
    var displayName: String {
        switch self {
        case .screenRecording: return "屏幕录制"
        case .microphone: return "麦克风"
        case .camera: return "摄像头"
        case .accessibility: return "辅助功能"
        case .fullDiskAccess: return "完全磁盘访问权限"
        }
    }
    
    var systemPreferencePath: String {
        switch self {
        case .screenRecording: return "x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture"
        case .microphone: return "x-apple.systempreferences:com.apple.preference.security?Privacy_Microphone"
        case .camera: return "x-apple.systempreferences:com.apple.preference.security?Privacy_Camera"
        case .accessibility: return "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
        case .fullDiskAccess: return "x-apple.systempreferences:com.apple.preference.security?Privacy_AllFiles"
        }
    }
}

// 权限状态枚举
enum PermissionStatus {
    case notDetermined      // 未确定
    case denied            // 被拒绝
    case granted           // 已授予
    case restricted        // 受限制
    
    var isGranted: Bool {
        return self == .granted
    }
}

// 权限请求结果
struct PermissionRequestResult {
    let permission: PermissionType
    let status: PermissionStatus
    let requestTime: Date
    let userAction: UserAction?
    
    enum UserAction {
        case granted
        case denied
        case openedSystemPreferences
        case cancelled
    }
}
```

### 1.2 权限管理服务实现
```swift
// 权限管理服务
class PermissionService: ObservableObject {
    @Published var permissionStatuses: [PermissionType: PermissionStatus] = [:]
    @Published var isCheckingPermissions: Bool = false
    
    private let notificationCenter = NotificationCenter.default
    
    // 初始化时检查所有权限状态
    init() {
        checkAllPermissions()
        setupPermissionMonitoring()
    }
    
    // 检查特定权限状态
    func checkPermissionStatus(for type: PermissionType) -> PermissionStatus {
        switch type {
        case .screenRecording:
            return checkScreenRecordingPermission()
        case .microphone:
            return checkMicrophonePermission()
        case .camera:
            return checkCameraPermission()
        case .accessibility:
            return checkAccessibilityPermission()
        case .fullDiskAccess:
            return checkFullDiskAccessPermission()
        }
    }
    
    // 请求权限
    func requestPermission(for type: PermissionType) async -> PermissionRequestResult {
        switch type {
        case .screenRecording:
            return await requestScreenRecordingPermission()
        case .microphone:
            return await requestMicrophonePermission()
        case .camera:
            return await requestCameraPermission()
        case .accessibility, .fullDiskAccess:
            return await requestSystemPermission(for: type)
        }
    }
    
    // 检查所有权限
    func checkAllPermissions() {
        isCheckingPermissions = true
        
        Task {
            for permissionType in PermissionType.allCases {
                let status = checkPermissionStatus(for: permissionType)
                await MainActor.run {
                    permissionStatuses[permissionType] = status
                }
            }
            
            await MainActor.run {
                isCheckingPermissions = false
            }
        }
    }
    
    // 打开系统偏好设置
    func openSystemPreferences(for type: PermissionType) {
        if let url = URL(string: type.systemPreferencePath) {
            NSWorkspace.shared.open(url)
        }
    }
    
    // 检查是否具有所有必需权限
    func hasAllRequiredPermissions() -> Bool {
        let requiredPermissions: [PermissionType] = [.screenRecording, .microphone]
        return requiredPermissions.allSatisfy { type in
            permissionStatuses[type]?.isGranted == true
        }
    }
    
    // MARK: - Private Methods
    
    private func checkScreenRecordingPermission() -> PermissionStatus {
        if #available(macOS 10.15, *) {
            let hasPermission = CGPreflightScreenCaptureAccess()
            return hasPermission ? .granted : .denied
        }
        return .granted // 旧版本系统不需要此权限
    }
    
    private func checkMicrophonePermission() -> PermissionStatus {
        switch AVCaptureDevice.authorizationStatus(for: .audio) {
        case .authorized: return .granted
        case .denied: return .denied
        case .restricted: return .restricted
        case .notDetermined: return .notDetermined
        @unknown default: return .notDetermined
        }
    }
    
    private func checkCameraPermission() -> PermissionStatus {
        switch AVCaptureDevice.authorizationStatus(for: .video) {
        case .authorized: return .granted
        case .denied: return .denied
        case .restricted: return .restricted
        case .notDetermined: return .notDetermined
        @unknown default: return .notDetermined
        }
    }
    
    private func checkAccessibilityPermission() -> PermissionStatus {
        let trusted = AXIsProcessTrusted()
        return trusted ? .granted : .denied
    }
    
    private func checkFullDiskAccessPermission() -> PermissionStatus {
        // 尝试访问受保护的目录来检查权限
        let protectedPath = "/Library/Application Support/com.apple.TCC/"
        let fileManager = FileManager.default
        
        return fileManager.isReadableFile(atPath: protectedPath) ? .granted : .denied
    }
    
    private func requestScreenRecordingPermission() async -> PermissionRequestResult {
        let initialStatus = checkScreenRecordingPermission()
        
        if initialStatus == .granted {
            return PermissionRequestResult(
                permission: .screenRecording,
                status: .granted,
                requestTime: Date(),
                userAction: .granted
            )
        }
        
        // 请求权限
        let granted = CGRequestScreenCaptureAccess()
        let finalStatus: PermissionStatus = granted ? .granted : .denied
        let userAction: PermissionRequestResult.UserAction = granted ? .granted : .denied
        
        await MainActor.run {
            permissionStatuses[.screenRecording] = finalStatus
        }
        
        return PermissionRequestResult(
            permission: .screenRecording,
            status: finalStatus,
            requestTime: Date(),
            userAction: userAction
        )
    }
    
    private func requestMicrophonePermission() async -> PermissionRequestResult {
        return await withCheckedContinuation { continuation in
            AVCaptureDevice.requestAccess(for: .audio) { granted in
                let status: PermissionStatus = granted ? .granted : .denied
                let userAction: PermissionRequestResult.UserAction = granted ? .granted : .denied
                
                Task { @MainActor in
                    self.permissionStatuses[.microphone] = status
                }
                
                continuation.resume(returning: PermissionRequestResult(
                    permission: .microphone,
                    status: status,
                    requestTime: Date(),
                    userAction: userAction
                ))
            }
        }
    }
    
    private func requestSystemPermission(for type: PermissionType) async -> PermissionRequestResult {
        // 对于需要在系统偏好设置中手动授予的权限
        openSystemPreferences(for: type)
        
        return PermissionRequestResult(
            permission: type,
            status: checkPermissionStatus(for: type),
            requestTime: Date(),
            userAction: .openedSystemPreferences
        )
    }
    
    private func setupPermissionMonitoring() {
        // 监听应用激活事件，重新检查权限状态
        notificationCenter.addObserver(
            forName: NSApplication.didBecomeActiveNotification,
            object: nil,
            queue: .main
        ) { [weak self] _ in
            self?.checkAllPermissions()
        }
    }
}
```

## 2. 云存储服务 (CloudService)

### 2.1 云服务抽象层设计
```swift
// 云服务提供商枚举
enum CloudProvider: String, CaseIterable {
    case iCloud = "icloud"
    case dropbox = "dropbox"
    case googleDrive = "google_drive"
    case oneDrive = "onedrive"
    
    var displayName: String {
        switch self {
        case .iCloud: return "iCloud Drive"
        case .dropbox: return "Dropbox"
        case .googleDrive: return "Google Drive"
        case .oneDrive: return "OneDrive"
        }
    }
    
    var iconName: String {
        switch self {
        case .iCloud: return "icloud"
        case .dropbox: return "dropbox"
        case .googleDrive: return "googledrive"
        case .oneDrive: return "onedrive"
        }
    }
}

// 云文件信息
struct CloudFile: Identifiable, Codable {
    let id: String
    let name: String
    let path: String
    let size: Int64
    let modifiedDate: Date
    let contentType: String
    let downloadURL: URL?
    let thumbnailURL: URL?
    let isDirectory: Bool
    let provider: CloudProvider
    
    var fileExtension: String {
        return URL(fileURLWithPath: name).pathExtension.lowercased()
    }
    
    var formattedSize: String {
        return ByteCountFormatter.string(fromByteCount: size, countStyle: .file)
    }
}

// 存储配额信息
struct StorageQuota: Codable {
    let totalSpace: Int64
    let usedSpace: Int64
    let availableSpace: Int64
    
    var usagePercentage: Double {
        guard totalSpace > 0 else { return 0 }
        return Double(usedSpace) / Double(totalSpace) * 100
    }
    
    var formattedTotalSpace: String {
        return ByteCountFormatter.string(fromByteCount: totalSpace, countStyle: .file)
    }
    
    var formattedUsedSpace: String {
        return ByteCountFormatter.string(fromByteCount: usedSpace, countStyle: .file)
    }
    
    var formattedAvailableSpace: String {
        return ByteCountFormatter.string(fromByteCount: availableSpace, countStyle: .file)
    }
}

// 同步状态枚举
enum SyncStatus {
    case idle                           // 空闲
    case syncing(progress: Double)      // 同步中
    case completed                      // 完成
    case failed(Error)                  // 失败
    case paused                         // 暂停
    
    var isActive: Bool {
        switch self {
        case .syncing:
            return true
        default:
            return false
        }
    }
}
```

### 2.2 云服务协议定义
```swift
// 云服务协议
protocol CloudService: ObservableObject {
    var provider: CloudProvider { get }
    var isAuthenticated: Bool { get }
    var syncStatus: SyncStatus { get }
    var storageQuota: StorageQuota? { get }
    
    // 认证相关
    func authenticate() async throws
    func signOut() async throws
    func refreshToken() async throws
    
    // 文件操作
    func upload(_ fileURL: URL, to remotePath: String, progress: @escaping (Double) -> Void) async throws -> CloudFile
    func download(_ cloudFile: CloudFile, to localURL: URL, progress: @escaping (Double) -> Void) async throws
    func listFiles(in path: String) async throws -> [CloudFile]
    func createFolder(at path: String) async throws -> CloudFile
    func deleteFile(_ cloudFile: CloudFile) async throws
    func moveFile(_ cloudFile: CloudFile, to newPath: String) async throws -> CloudFile
    func copyFile(_ cloudFile: CloudFile, to newPath: String) async throws -> CloudFile
    
    // 存储信息
    func getStorageQuota() async throws -> StorageQuota
    func getFileInfo(at path: String) async throws -> CloudFile
    
    // 同步功能
    func startSync() async throws
    func pauseSync() async throws
    func stopSync() async throws
}

// 云服务错误类型
enum CloudServiceError: Error, LocalizedError {
    case notAuthenticated
    case networkError(Error)
    case quotaExceeded
    case fileNotFound(String)
    case uploadFailed(String)
    case downloadFailed(String)
    case iCloudNotAvailable
    case authenticationFailed
    case invalidCredentials
    case serviceUnavailable
    
    var errorDescription: String? {
        switch self {
        case .notAuthenticated:
            return "未登录云服务"
        case .networkError(let error):
            return "网络错误: \(error.localizedDescription)"
        case .quotaExceeded:
            return "云存储空间已满"
        case .fileNotFound(let path):
            return "文件未找到: \(path)"
        case .uploadFailed(let reason):
            return "上传失败: \(reason)"
        case .downloadFailed(let reason):
            return "下载失败: \(reason)"
        case .iCloudNotAvailable:
            return "iCloud 不可用"
        case .authenticationFailed:
            return "认证失败"
        case .invalidCredentials:
            return "凭据无效"
        case .serviceUnavailable:
            return "服务暂时不可用"
        }
    }
}
```

---

**文档版本**: 1.0.0  
**创建日期**: 2025年9月25日  
**最后更新**: 2025年9月25日