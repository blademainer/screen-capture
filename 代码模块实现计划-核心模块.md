# Mac屏幕录制与截图软件 - 核心模块详细设计

## 1. 截图模块 (ScreenshotModule)

### 1.1 功能需求
- **区域截图**: 用户自定义选择屏幕区域进行截图
- **窗口截图**: 智能识别并截取指定应用程序窗口
- **全屏截图**: 捕获整个屏幕或指定显示器内容
- **滚动截图**: 自动滚动并拼接长页面内容
- **多显示器支持**: 支持跨屏幕截图和独立显示器截图
- **像素级精确选择**: 提供精确的区域选择功能

### 1.2 输入输出参数
```swift
// 截图配置参数
struct ScreenshotConfig {
    let captureType: CaptureType        // 截图类型
    let targetDisplay: NSScreen?        // 目标显示器
    let region: CGRect?                 // 截图区域
    let includeWindowShadow: Bool       // 是否包含窗口阴影
    let outputFormat: ImageFormat       // 输出格式
    let quality: Float                  // 图像质量 (0.0-1.0)
    let includeMouseCursor: Bool        // 是否包含鼠标光标
    let delaySeconds: Int               // 延迟截图时间
}

// 截图类型枚举
enum CaptureType {
    case region                         // 区域截图
    case window(windowID: CGWindowID)   // 窗口截图
    case fullscreen                     // 全屏截图
    case scrolling(scrollView: NSView)  // 滚动截图
}

// 截图结果
struct ScreenshotResult {
    let image: NSImage                  // 截图图像
    let metadata: CaptureMetadata       // 截图元数据
    let filePath: URL?                  // 保存路径
    let timestamp: Date                 // 截图时间戳
    let fileSize: Int64                 // 文件大小
}
```

### 1.3 核心类设计
```swift
// 截图引擎主类
class ScreenshotEngine {
    private let displayManager: DisplayManager
    private let windowManager: WindowManager
    private let imageProcessor: ImageProcessor
    
    // 主要截图方法
    func captureScreen(config: ScreenshotConfig) async throws -> ScreenshotResult
    func captureRegion(_ rect: CGRect, display: NSScreen) async throws -> NSImage
    func captureWindow(_ windowID: CGWindowID, includeShadow: Bool) async throws -> NSImage
    func captureScrollingContent(in view: NSView, maxHeight: CGFloat) async throws -> NSImage
    
    // 辅助方法
    func getAvailableDisplays() -> [NSScreen]
    func detectWindowsAtPoint(_ point: CGPoint) -> [WindowInfo]
    func validateCaptureRegion(_ rect: CGRect, on display: NSScreen) -> Bool
    func optimizeImageForFormat(_ image: NSImage, format: ImageFormat) -> NSImage
}
```

### 1.4 预期性能指标
- **截图响应时间**: < 0.5秒 (1080p分辨率)
- **内存占用**: < 100MB (单次截图操作)
- **支持最大分辨率**: 8K (7680×4320)
- **并发截图数量**: 最多3个同时进行
- **滚动截图最大长度**: 50,000像素

### 1.5 错误处理机制
```swift
enum ScreenshotError: Error, LocalizedError {
    case permissionDenied               // 权限被拒绝
    case displayNotFound                // 显示器未找到
    case regionOutOfBounds              // 区域超出边界
    case memoryInsufficient             // 内存不足
    case fileWriteError(URL)            // 文件写入错误
    case windowNotAccessible(CGWindowID) // 窗口不可访问
    case scrollingFailed                // 滚动截图失败
    case imageProcessingFailed          // 图像处理失败
    
    var errorDescription: String? {
        switch self {
        case .permissionDenied:
            return "屏幕录制权限被拒绝，请在系统偏好设置中授予权限"
        case .displayNotFound:
            return "未找到指定的显示器"
        case .regionOutOfBounds:
            return "截图区域超出屏幕边界"
        case .memoryInsufficient:
            return "内存不足，无法完成截图操作"
        case .fileWriteError(let url):
            return "无法写入文件到路径: \(url.path)"
        case .windowNotAccessible(let windowID):
            return "无法访问窗口 ID: \(windowID)"
        case .scrollingFailed:
            return "滚动截图操作失败"
        case .imageProcessingFailed:
            return "图像处理失败"
        }
    }
}
```

## 2. 录制模块 (RecordingModule)

### 2.1 功能需求
- **屏幕录制**: 高质量实时屏幕内容录制
- **区域录制**: 指定屏幕区域的精确录制
- **音频录制**: 同步录制系统音频和麦克风输入
- **多格式输出**: 支持MP4、MOV、WebM等格式
- **实时编码**: H.264/H.265硬件加速编码
- **性能监控**: 实时监控录制性能指标

### 2.2 输入输出参数
```swift
// 录制配置参数
struct RecordingConfig {
    let captureType: CaptureType        // 录制类型
    let region: CGRect?                 // 录制区域
    let frameRate: Int                  // 帧率 (15, 30, 60)
    let resolution: CGSize              // 分辨率
    let videoCodec: VideoCodec          // 视频编码器
    let audioConfig: AudioConfig?       // 音频配置
    let outputFormat: VideoFormat       // 输出格式
    let quality: RecordingQuality       // 录制质量
    let maxDuration: TimeInterval?      // 最大录制时长
    let includeMouseCursor: Bool        // 是否包含鼠标光标
}

// 录制结果
struct RecordingResult {
    let videoURL: URL                   // 视频文件路径
    let duration: TimeInterval          // 录制时长
    let fileSize: Int64                 // 文件大小
    let metadata: RecordingMetadata     // 录制元数据
    let thumbnailImage: NSImage?        // 缩略图
    let statistics: RecordingStatistics // 录制统计信息
}
```

### 2.3 核心类设计
```swift
// 录制引擎主类
class RecordingEngine: ObservableObject {
    @Published var isRecording: Bool = false
    @Published var isPaused: Bool = false
    @Published var currentDuration: TimeInterval = 0
    @Published var statistics: RecordingStatistics?
    
    private let captureSession: AVCaptureSession
    private let videoOutput: AVCaptureVideoDataOutput
    private let audioOutput: AVCaptureAudioDataOutput
    private let writer: AVAssetWriter
    private let performanceMonitor: PerformanceMonitor
    
    // 主要录制方法
    func startRecording(config: RecordingConfig) async throws
    func pauseRecording() async throws
    func resumeRecording() async throws
    func stopRecording() async throws -> RecordingResult
    func cancelRecording() async throws
    
    // 状态查询方法
    func getCurrentDuration() -> TimeInterval
    func getRecordingStatistics() -> RecordingStatistics
    func getEstimatedFileSize() -> Int64
}
```

### 2.4 预期性能指标
- **录制启动时间**: < 2秒
- **CPU占用率**: < 30% (1080p@30fps, H.264)
- **内存占用**: < 500MB (持续录制)
- **最大录制时长**: 8小时
- **支持同时录制数量**: 1个 (主录制)
- **丢帧率**: < 0.1% (正常系统负载下)

### 2.5 错误处理机制
```swift
enum RecordingError: Error, LocalizedError {
    case sessionConfigurationFailed     // 会话配置失败
    case audioDeviceUnavailable         // 音频设备不可用
    case diskSpaceInsufficient          // 磁盘空间不足
    case encodingFailed(reason: String) // 编码失败
    case systemResourcesExhausted       // 系统资源耗尽
    case recordingInterrupted           // 录制被中断
    case invalidConfiguration           // 配置无效
    case hardwareNotSupported           // 硬件不支持
}
```

## 3. 编辑模块 (EditingModule)

### 3.1 功能需求
- **图像标注工具**: 箭头、文字、形状、高亮、马赛克等
- **视频基础编辑**: 剪切、分割、转场效果、字幕、水印
- **实时预览**: 编辑操作的实时预览功能
- **撤销/重做**: 支持多步撤销和重做操作
- **批量处理**: 支持批量应用编辑操作
- **滤镜效果**: 内置多种图像和视频滤镜

### 3.2 输入输出参数
```swift
// 编辑操作参数
struct EditOperation {
    let id: UUID                        // 操作唯一标识
    let type: EditType                  // 编辑类型
    let parameters: [String: Any]       // 操作参数
    let targetRect: CGRect?             // 目标区域
    let timestamp: Date                 // 操作时间戳
    let duration: TimeInterval?         // 持续时间 (视频编辑)
}

// 编辑类型枚举
enum EditType {
    // 图像编辑
    case addAnnotation(AnnotationType)  // 添加标注
    case applyFilter(FilterType)        // 应用滤镜
    case crop(CGRect)                   // 裁剪
    case resize(CGSize)                 // 调整大小
    case rotate(angle: Float)           // 旋转
    case adjustColors(ColorAdjustment)  // 颜色调整
    
    // 视频编辑
    case trim(startTime: CMTime, endTime: CMTime) // 修剪
    case split(at: CMTime)              // 分割
    case addTransition(TransitionType)  // 添加转场
    case addSubtitle(SubtitleInfo)      // 添加字幕
    case addWatermark(WatermarkInfo)    // 添加水印
    case adjustSpeed(multiplier: Float) // 调整播放速度
}
```

### 3.3 核心类设计
```swift
// 编辑引擎主类
class EditingEngine: ObservableObject {
    @Published var currentContent: EditableContent?
    @Published var operationHistory: [EditOperation] = []
    @Published var canUndo: Bool = false
    @Published var canRedo: Bool = false
    
    private var operationStack: [EditOperation] = []
    private var undoStack: [EditOperation] = []
    private let imageProcessor: ImageProcessor
    private let videoProcessor: VideoProcessor
    private let previewGenerator: PreviewGenerator
    
    // 主要编辑方法
    func loadContent(_ content: EditableContent) async throws
    func applyOperation(_ operation: EditOperation) async throws -> EditResult
    func applyOperations(_ operations: [EditOperation]) async throws -> EditResult
    func generatePreview() async throws -> NSImage
    
    // 操作管理方法
    func undo() async throws -> Bool
    func redo() async throws -> Bool
    func clearHistory()
    func exportEditedContent(format: OutputFormat) async throws -> URL
}
```

### 3.4 预期性能指标
- **编辑操作响应时间**: < 0.1秒 (简单操作)
- **预览生成时间**: < 1秒 (1080p图像)
- **支持最大图像尺寸**: 50MP (7071×7071)
- **撤销操作数量**: 最多50步
- **视频处理速度**: > 1x实时速度 (1080p)
- **内存占用**: < 1GB (复杂编辑操作)

## 4. 文件管理模块 (FileManagerModule)

### 4.1 功能需求
- **多格式输出支持**: PNG、JPEG、TIFF、WebP、MP4、MOV、GIF等
- **文件自动命名和组织**: 基于时间戳和用户规则的智能命名
- **批量处理**: 支持批量格式转换和大小调整
- **云存储同步**: 集成iCloud、Dropbox、Google Drive等
- **文件完整性验证**: 确保文件保存和传输的完整性
- **存储空间管理**: 自动清理临时文件和重复文件

### 4.2 输入输出参数
```swift
// 文件保存配置
struct FileSaveConfig {
    let outputPath: URL                 // 输出路径
    let format: FileFormat              // 文件格式
    let quality: Float                  // 质量设置 (0.0-1.0)
    let compressionLevel: Int           // 压缩级别
    let metadata: [String: Any]         // 元数据
    let namingRule: NamingRule          // 命名规则
    let overwriteExisting: Bool         // 是否覆盖现有文件
}

// 批量处理配置
struct BatchProcessConfig {
    let sourceFiles: [URL]              // 源文件列表
    let operations: [BatchOperation]    // 批量操作
    let outputDirectory: URL            // 输出目录
    let namingPattern: String           // 命名模式
    let preserveStructure: Bool         // 保持目录结构
    let skipErrors: Bool                // 跳过错误文件
}
```

### 4.3 核心类设计
```swift
// 文件管理器主类
class FileManager: ObservableObject {
    @Published var recentFiles: [FileInfo] = []
    @Published var syncStatus: SyncStatus = .idle
    @Published var storageUsage: StorageInfo?
    
    private let cloudServices: [CloudProvider: CloudService] = [:]
    private let fileValidator: FileValidator
    private let compressionEngine: CompressionEngine
    private let encryptionService: EncryptionService
    
    // 文件保存方法
    func saveImage(_ image: NSImage, config: FileSaveConfig) async throws -> URL
    func saveVideo(_ asset: AVAsset, config: FileSaveConfig) async throws -> URL
    func saveToClipboard(_ content: Any) throws
    
    // 批量处理方法
    func processBatch(config: BatchProcessConfig) async throws -> [FileOperationResult]
    func convertFiles(_ files: [URL], to format: FileFormat) async throws -> [URL]
    func resizeImages(_ images: [URL], to size: CGSize) async throws -> [URL]
}
```

### 4.4 预期性能指标
- **文件保存速度**: > 50MB/s (SSD存储)
- **批量处理速度**: > 10文件/秒 (图像格式转换)
- **云同步速度**: 受网络带宽限制
- **文件验证速度**: > 100MB/s
- **重复文件检测**: > 1000文件/分钟

## 5. 设置管理模块 (SettingsModule)

### 5.1 功能需求
- **用户偏好设置存储**: 持久化保存用户配置
- **快捷键管理**: 自定义和冲突检测
- **配置导入导出**: 设置备份和恢复
- **实时设置同步**: 设置变更的实时响应
- **多用户配置**: 支持多用户环境下的独立配置
- **设置验证**: 确保配置的有效性和兼容性

### 5.2 输入输出参数
```swift
// 通用设置
struct GeneralSettings: Codable {
    var launchAtStartup: Bool = false           // 开机启动
    var showInMenuBar: Bool = true              // 显示菜单栏图标
    var theme: AppTheme = .system               // 应用主题
    var language: AppLanguage = .system         // 界面语言
    var checkForUpdates: Bool = true            // 检查更新
    var enableAnalytics: Bool = false           // 启用分析
    var defaultSaveLocation: URL                // 默认保存位置
    var fileNamingPattern: String = "Screenshot_%timestamp%" // 文件命名模式
}

// 快捷键设置
struct ShortcutSettings: Codable {
    var regionScreenshot: KeyCombination = KeyCombination(.command, .shift, .key4)
    var windowScreenshot: KeyCombination = KeyCombination(.command, .shift, .key4, .space)
    var fullScreenshot: KeyCombination = KeyCombination(.command, .shift, .key3)
    var scrollingScreenshot: KeyCombination = KeyCombination(.command, .shift, .key5)
    var startStopRecording: KeyCombination = KeyCombination(.command, .shift, .keyR)
    var pauseRecording: KeyCombination = KeyCombination(.command, .shift, .keyP)
}
```

### 5.3 核心类设计
```swift
// 设置管理器主类
class SettingsManager: ObservableObject {
    @Published var generalSettings = GeneralSettings()
    @Published var shortcutSettings = ShortcutSettings()
    @Published var recordingSettings = RecordingSettings()
    @Published var screenshotSettings = ScreenshotSettings()
    @Published var outputSettings = OutputSettings()
    @Published var cloudSyncSettings = CloudSyncSettings()
    
    private let userDefaults: UserDefaults
    private let keychain: KeychainService
    private let validator: SettingsValidator
    private let migrator: SettingsMigrator
    
    // 设置管理方法
    func loadSettings() async throws
    func saveSettings() async throws
    func resetToDefaults() async throws
    func validateSettings() async throws -> ValidationResult
    
    // 导入导出方法
    func exportSettings(to url: URL, includeSecrets: Bool = false) async throws
    func importSettings(from url: URL) async throws
    func createSettingsBackup() async throws -> URL
    func restoreFromBackup(_ backupURL: URL) async throws
}
```

### 5.4 预期性能指标
- **设置加载时间**: < 0.1秒
- **设置保存时间**: < 0.05秒
- **快捷键响应时间**: < 0.01秒
- **设置验证时间**: < 0.1秒
- **导入导出时间**: < 1秒
- **云同步时间**: < 5秒 (小配置文件)

---

**文档版本**: 1.0.0  
**创建日期**: 2025年9月25日  
**最后更新**: 2025年9月25日