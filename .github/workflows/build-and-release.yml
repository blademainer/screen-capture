name: Build and Release MacScreenCapture

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  XCODE_VERSION: '15.0'
  MACOS_VERSION: 'macos-13'

jobs:
  build-and-release:
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Update version in project
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"
        
        # æ›´æ–° Info.plist ä¸­çš„ç‰ˆæœ¬å·
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION_NUMBER" MacScreenCapture/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION_NUMBER" MacScreenCapture/Info.plist
        
        echo "Updated version to $VERSION_NUMBER"
        
    - name: Import Code-Signing Certificates
      uses: Apple-Actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
        p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
      if: ${{ secrets.CERTIFICATES_P12 }}
        
    - name: Build for Release
      run: |
        # æ¸…ç†ä¹‹å‰çš„æž„å»º
        xcodebuild clean -project MacScreenCapture.xcodeproj -scheme MacScreenCapture
        
        # æž„å»º Release ç‰ˆæœ¬
        xcodebuild archive \
          -project MacScreenCapture.xcodeproj \
          -scheme MacScreenCapture \
          -configuration Release \
          -archivePath ./build/MacScreenCapture.xcarchive \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY || '-' }}" \
          DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM || '' }}" \
          CODE_SIGN_STYLE=Manual
          
    - name: Export App
      run: |
        # åˆ›å»ºå¯¼å‡ºé€‰é¡¹ plist
        cat > ./ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>${{ secrets.DEVELOPMENT_TEAM || '' }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        # å¯¼å‡ºåº”ç”¨
        xcodebuild -exportArchive \
          -archivePath ./build/MacScreenCapture.xcarchive \
          -exportPath ./build/export \
          -exportOptionsPlist ./ExportOptions.plist
          
    - name: Notarize App (if certificates available)
      run: |
        if [ -n "${{ secrets.NOTARIZATION_USERNAME }}" ] && [ -n "${{ secrets.NOTARIZATION_PASSWORD }}" ]; then
          echo "Starting notarization process..."
          
          # åˆ›å»º DMG
          hdiutil create -volname "MacScreenCapture" -srcfolder ./build/export -ov -format UDZO ./build/MacScreenCapture.dmg
          
          # å…¬è¯ DMG
          xcrun notarytool submit ./build/MacScreenCapture.dmg \
            --apple-id "${{ secrets.NOTARIZATION_USERNAME }}" \
            --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
            --team-id "${{ secrets.DEVELOPMENT_TEAM }}" \
            --wait
            
          # è£…è®¢å…¬è¯ç¥¨æ®
          xcrun stapler staple ./build/MacScreenCapture.dmg
          
          echo "Notarization completed"
        else
          echo "Skipping notarization - credentials not available"
          # åˆ›å»ºæœªå…¬è¯çš„ DMG
          hdiutil create -volname "MacScreenCapture" -srcfolder ./build/export -ov -format UDZO ./build/MacScreenCapture.dmg
        fi
      if: ${{ secrets.CERTIFICATES_P12 }}
      
    - name: Create ZIP for unsigned build
      run: |
        if [ ! -f "./build/MacScreenCapture.dmg" ]; then
          echo "Creating ZIP package for unsigned build..."
          cd ./build/export
          zip -r ../MacScreenCapture.zip .
          cd ../..
        fi
      if: ${{ !secrets.CERTIFICATES_P12 }}
      
    - name: Generate Release Notes
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        cat > release_notes.md << EOF
        # MacScreenCapture $VERSION
        
        ## ðŸŽ‰ æ–°åŠŸèƒ½
        - é«˜è´¨é‡å±å¹•å½•åˆ¶ (æ”¯æŒ 60fps)
        - å¤šç§æˆªå›¾æ¨¡å¼ (å…¨å±ã€åŒºåŸŸã€çª—å£)
        - éŸ³é¢‘å½•åˆ¶æ”¯æŒ (ç³»ç»ŸéŸ³é¢‘ + éº¦å…‹é£Ž)
        - å¤šæ˜¾ç¤ºå™¨æ”¯æŒ
        - å®žæ—¶æ€§èƒ½ç›‘æŽ§
        
        ## ðŸ›  æŠ€æœ¯ç‰¹æ€§
        - åŸºäºŽ ScreenCaptureKit æ¡†æž¶
        - SwiftUI çŽ°ä»£åŒ–ç•Œé¢
        - H.264 è§†é¢‘ç¼–ç ï¼Œå…¼å®¹ QuickTime
        - ä¼˜åŒ–çš„å†…å­˜å’Œ CPU ä½¿ç”¨
        
        ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        - macOS 12.0 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ”¯æŒ ScreenCaptureKit çš„ Mac è®¾å¤‡
        
        ## ðŸ”§ å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½å¹¶è§£åŽ‹åº”ç”¨ç¨‹åº
        2. å°† MacScreenCapture.app æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        3. é¦–æ¬¡è¿è¡Œæ—¶æŽˆäºˆå±å¹•å½•åˆ¶æƒé™
        
        ## ðŸ“ æ›´æ–°æ—¥å¿—
        - ä¿®å¤äº†è§†é¢‘æ–‡ä»¶ QuickTime å…¼å®¹æ€§é—®é¢˜
        - ä¼˜åŒ–äº†å½•åˆ¶æ€§èƒ½å’Œç¨³å®šæ€§
        - æ”¹è¿›äº†ç”¨æˆ·ç•Œé¢å“åº”é€Ÿåº¦
        - å¢žå¼ºäº†å¤šæ˜¾ç¤ºå™¨æ”¯æŒ
        EOF
        
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: MacScreenCapture ${{ steps.version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        files: |
          ./build/MacScreenCapture.dmg
          ./build/MacScreenCapture.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MacScreenCapture-${{ steps.version.outputs.VERSION }}
        path: |
          ./build/export/
          ./build/MacScreenCapture.dmg
          ./build/MacScreenCapture.zip
        retention-days: 30